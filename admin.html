<!DOCTYPE html>
<html lang="es">
<head>
    <title>ğŸ‘‘ Ubipet Admin</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/estilos.css?v=2">
    <style>
        /* ESTILOS ESPECÃFICOS admin.html - NO TOCAR resto */
        .crear-form { background: rgba(232,245,232,0.8); padding: 20px; border-radius: 20px; margin: 20px 0; backdrop-filter: blur(10px); }
        .pendiente-row { background: rgba(255,243,205,0.9); padding: 15px; margin: 10px 0; border-radius: 15px; border-left: 5px solid #ffd93d; }
        .cliente-row { background: rgba(248,249,250,0.9); padding: 15px; margin: 10px 0; border-radius: 15px; }
        .btn-procesar, .btn-cerrar, .btn-manual { background: var(--pet-green); padding: 10px 20px; border-radius: 12px; font-weight: 600; margin: 5px; }
        .btn-cerrar { background: var(--pet-orange) !important; }
        .btn-manual { background: var(--pet-blue) !important; }
        #pendientesLista, #clientesLista { max-height: 400px; overflow-y: auto; border-radius: 15px; }
        .loading, .success, .error { padding: 15px; border-radius: 15px; margin: 15px 0; backdrop-filter: blur(10px); }
    </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ‘‘ UBIPET ADMIN</h1>
    
    <div id="loginAdmin">
      <input type="email" id="adminEmail" placeholder="Admin@uejemplo.com">
      <input type="password" id="adminPass" placeholder="123456">
      <button id="btnLogin">ğŸ” ACCEDER ADMIN</button>
    </div>
    
    <div id="adminDash" style="display:none;">
      <h2>ğŸ“Š DASHBOARD COMPLETO</h2>
      
      <div class="section">
        <h3>â³ SOLICITUDES PENDIENTES</h3>
        <div id="pendientesLista">Cargando...</div>
      </div>
      
      <div class="crear-form section">
        <h3>â• NUEVO CLIENTE MANUAL</h3>
        <input id="newEmail" placeholder="cliente@placa.cl">
        <input id="newPass" value="Ubipet123" style="width:200px;">
        <input id="newPhone" placeholder="+56912345678" style="width:200px;">
        <button id="btnCrearCliente" class="btn-manual">ğŸš€ Crear Manual</button>
        <div id="statusMessage"></div>
      </div>
     
<h3>ğŸ†• Generar Placa Individual UBP</h3>
<input id="cliente-email-preset" placeholder="cliente@ejemplo.com"...>
<button onclick="generarPlacaIndividual()">ğŸ†• Crear Placa UBP</button>

<div style="margin-top:10px;">
  <input id="input-placa-qr" placeholder="UBP00011"...>
  <button onclick="generarQrImagen()">ğŸ–¨ï¸ Generar QR ImpresiÃ³n</button>
  <div id="qr-imagen"></div>
</div>

<div id="placas-preset-lista"...



      <div id="clientesLista">Cargando...</div>
      
      <button id="btnLogout" style="background:#f44336;">ğŸšª Salir</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://exeeqykieytuvlzdbsnn.supabase.co';
const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4ZWVxeWtpZXl0dXZsemRic25uIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTYwNDUyMywiZXhwIjoyMDg3MTgwNTIzfQ.YLI0hmWB8BLKZEl1Wn6dlzqYolCEJKwpxnmUo-AKtUo';
      
const sbAdmin = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false }
});
      const SUPERUSER = { email: 'samirignaciosb@gmail.com', password: 'Admin123' };

    // Event listeners
    document.getElementById('btnLogin').addEventListener('click', adminLogin);
    document.getElementById('btnCrearCliente').addEventListener('click', crearClienteManual);
    document.getElementById('btnLogout').addEventListener('click', logoutAdmin);

    async function adminLogin() {
  const email = document.getElementById('adminEmail').value;
  const pass = document.getElementById('adminPass').value;
  
  if (email !== SUPERUSER.email || pass !== SUPERUSER.password) {
    alert('âŒ Solo: samirignaciosb@gmail.com / Admin123');
    return;
  }
  
  document.getElementById('loginAdmin').style.display = 'none';
  document.getElementById('adminDash').style.display = 'block';
  
  await cargarPendientes();
  await cargarClientes();
  alert('âœ… Â¡ADMIN LIVE!');
  
  // â­ AUTO-LOAD PLACAS UBP - AGREGAR ESTAS 4 LÃNEAS
  setTimeout(() => {
    if (window.listarPlacasPreset) {
      window.listarPlacasPreset();
      console.log('ğŸ” Placas UBP cargadas');
    }
  }, 1500);
}
// â­ FUNCION LISTAR PLACAS PRESET UBP - FALTABA ESTA
window.listarPlacasPreset = async function() {
  try {
    document.getElementById('placas-preset-lista').innerHTML = 'ğŸ”„ Cargando placas...';
    
    const { data: placas, error } = await sbAdmin
      .from('perfiles_preset')
      .select('*')
      .is('cliente_email', null)
      .eq('status', 'lista_venta')
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    if (!placas?.length) {
      document.getElementById('placas-preset-lista').innerHTML = 'ğŸ‰ Â¡Sin placas disponibles!';
      return;
    }
    
    document.getElementById('placas-preset-lista').innerHTML = placas.map(p => `
      <div class="pendiente-row">
        <strong>ğŸ†• ${p.id}</strong> | QR: ${p.qr_uuid?.slice(0,8)}...
        <br><small>${new Date(p.created_at).toLocaleString('es-CL')}</small>
      </div>
    `).join('');
    
  } catch(error) {
    document.getElementById('placas-preset-lista').innerHTML = `âŒ Error: ${error.message}`;
  }
};

// â­ FUNCION GENERAR PLACA INDIVIDUAL UBP - FALTABA ESTA
window.generarPlacaIndividual = async function() {
  const email = document.getElementById('cliente-email-preset').value.trim();
  if (!email.includes('@')) {
    alert('âŒ Email invÃ¡lido');
    return;
  }
  
  try {
    // 1. Buscar placa disponible
    const { data: placaDisponible } = await sbAdmin
      .from('perfiles_preset')
      .select('id, qr_uuid')
      .is('cliente_email', null)
      .eq('status', 'lista_venta')
      .limit(1)
      .maybeSingle();
    
    if (!placaDisponible) {
      alert('âŒ Sin placas disponibles');
      return;
    }
    
    // 2. Generar NUEVA placa secuencial UBP00126+
    const ultimoId = await sbAdmin
      .from('perfiles_preset')
      .select('id')
      .order('id', { ascending: false })
      .limit(1);
    
    const nextNum = parseInt(ultimoId.data?.[0]?.id.slice(3)) + 1 || 126;
    const nuevaPlacaId = `UBP${nextNum.toString().padStart(5, '0')}`;
    const nuevoQrUuid = crypto.randomUUID();
    
    // 3. INSERT nueva placa
    await sbAdmin.from('perfiles_preset').insert({
      id: nuevaPlacaId,
      qr_uuid: nuevoQrUuid,
      status: 'lista_venta',
      cliente_email: null,
      created_at: new Date().toISOString()
    });
    
    // 4. Alert QR
    alert(`âœ… PLACA CREADA: ubipet.cl/qr/${nuevaPlacaId}`);
    
    // 5. Limpiar campo
    document.getElementById('cliente-email-preset').value = '';
    
    // 6. Refresh lista
    await window.listarPlacasPreset();
    
  } catch(error) {
    alert('âŒ Error: ' + error.message);
  }
};

      
    function logoutAdmin() {
      document.getElementById('adminDash').style.display = 'none';
      document.getElementById('loginAdmin').style.display = 'block';
      document.getElementById('adminEmail').value = '';
      document.getElementById('adminPass').value = '';
    }

    async function cargarPendientes() {
      try {
        document.getElementById('pendientesLista').innerHTML = 'ğŸ”„ Cargando...';
        const { data: pendientes, error } = await sbAdmin
          .from('solicitudes_placas')
          .select('*')
          .eq('aprobado', false)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        if (!pendientes?.length) {
          document.getElementById('pendientesLista').innerHTML = 'ğŸ‰ Â¡Sin pendientes! ğŸ‘';
          return;
        }
        
        document.getElementById('pendientesLista').innerHTML = pendientes.map(p => `
          <div class="pendiente-row">
            <strong>ğŸ‘¤ ${p.nombre}</strong><br>
            ğŸ“§ ${p.email}<br>
            ğŸ“± ${p.telefono}<br>
            <small>${new Date(p.created_at).toLocaleString('es-CL')}</small><br>
            <button class="btn-procesar" data-id="${p.id}" data-nombre="${p.nombre}" data-email="${p.email}" data-telefono="${p.telefono}">ğŸš€ CREAR USER + NOTIFICAR</button>
            <button class="btn-cerrar" data-id="${p.id}">âŒ Eliminar</button>
          </div>
        `).join('');
        
        document.querySelectorAll('.btn-procesar').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const nombre = this.dataset.nombre;
            const email = this.dataset.email;
            const telefono = this.dataset.telefono;
            procesarSolicitud(id, nombre, email, telefono);
          });
        });
        
        document.querySelectorAll('.btn-cerrar').forEach(btn => {
          btn.addEventListener('click', function() {
            eliminarSolicitud(this.dataset.id);
          });
        });
        
      } catch(error) {
        document.getElementById('pendientesLista').innerHTML = `âŒ Error: ${error.message}`;
      }
    }

 async function procesarSolicitud(id, nombre, email, telefono) {
  try {
    // âœ… SOLO APROBAR
    await sbAdmin.from('solicitudes_placas').update({ aprobado: true }).eq('id', id);
    
    // âœ… WhatsApp CLIENTE
    const cleanTel = telefono.replace(/[^0-9]/g, '');
    const mensajeCliente = `ğŸ• *Â¡UBIPET APROBADO!* ${nombre}âœ… Ya puedes crear tu cuenta:ğŸ“§ ${email}ğŸ”— https://samirignaciosb-art.github.io/UbiPet/Â¡Haz login y completa tu perfil! ğŸ•ğŸ’°`;
    
    window.open(`https://wa.me/${cleanTel}?text=${encodeURIComponent(mensajeCliente)}`, '_blank');
    window.open(`https://wa.me/56979928352?text=âœ… APROBADO: ${email}`, '_blank');
    
    alert(`ğŸ‰ CLIENTE APROBADO! ${email}`);
    await cargarPendientes();
  } catch(error) {
    alert('âŒ ' + error.message);
  }
}



    async function eliminarSolicitud(id) {
      if (!confirm('Â¿Eliminar esta solicitud?')) return;
      await sbAdmin.from('solicitudes_placas').delete().eq('id', id);
      await cargarPendientes();
    }

async function crearClienteManual() {
  const email = document.getElementById('newEmail').value.trim();
  const pass = document.getElementById('newPass').value || 'Ubipet123';
  const telefono = document.getElementById('newPhone').value.trim();
  
  if (!email.includes('@') || !telefono) {
    mostrarStatus('âŒ Email o telÃ©fono invÃ¡lido', 'error');
    return;
  }
  
  const btn = document.getElementById('btnCrearCliente');
  const originalText = btn.innerHTML;
  btn.innerHTML = 'â³ Creando...';
  btn.disabled = true;
  
  try {
    const { data: authData, error: authError } = await sbAdmin.auth.signUp({
      email, password: pass, options: { data: { telefono } }
    });
    
    if (authError) throw authError;
    
    await sbAdmin.auth.signInWithPassword({ email, password: pass });
    
    await sbAdmin.from('perfiles').insert({
      user_id: authData.user.id,
      nombre: 'Tu mascota ğŸ•',
      nombre_dueno: 'DueÃ±o',
      email_dueno: email,
      telefono: telefono,
      raza: 'Mixta'
    });
    
    document.getElementById('newEmail').value = '';
    document.getElementById('newPhone').value = '';
    mostrarStatus(`âœ… CREADO: ${email}`, 'success');
    await cargarClientes();
    
  } catch(error) {
    mostrarStatus(`âŒ Error: ${error.message}`, 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

    async function cargarClientes() {
      try {
        document.getElementById('clientesLista').innerHTML = 'ğŸ”„ Cargando...';
        const { data: clientes, error } = await sbAdmin
          .from('perfiles')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        if (!clientes?.length) {
          document.getElementById('clientesLista').innerHTML = 'ğŸ• Sin clientes aÃºn';
          return;
        }
        
        document.getElementById('clientesLista').innerHTML = clientes.map(c => `
          <div class="cliente-row">
            <strong>ğŸ• ${c.nombre || 'Sin datos'}</strong><br>
            ğŸ‘¤ ${c.nombre_dueno || 'Sin dueÃ±o'} | ğŸ“§ ${c.email_dueno || 'Sin email'}<br>
            <span style="color:${c.esta_perdida ? '#f44336' : '#4CAF50'}; font-weight:bold;">
              ${c.esta_perdida ? 'ğŸš¨ PERDIDA' : 'ğŸŸ¢ ACTIVA'}
            </span><br>
            <small>ID: ${c.user_id?.slice(0,8)}... | ${new Date(c.created_at).toLocaleDateString('es-CL')}</small>
          </div>
        `).join('');
        
      } catch(error) {
        document.getElementById('clientesLista').innerHTML = `âŒ Error: ${error.message}`;
      }
    }
    function mostrarStatus(mensaje, tipo) {
      const status = document.getElementById('statusMessage');
      status.innerHTML = `<div class="${tipo}">${mensaje}</div>`;
      setTimeout(() => status.innerHTML = '', 5000);
    }

    console.log('âœ… Ubipet Admin 100% FIXEADO - Jorge LISTO');
  </script>
</body>
</html>
