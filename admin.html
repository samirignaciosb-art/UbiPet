<!DOCTYPE html>
<html lang="es">
<head>
  <title>ğŸ‘‘ Ubipet Admin $15/placa</title>
  <style>
    body { background: #f7ede3; font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
    .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); max-width: 900px; width: 100%; text-align: center; }
    input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
    button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; background: #4CAF50; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
    button:hover { opacity: 0.9; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .crear-form { background: #e8f5e8; padding: 20px; border-radius: 15px; margin: 20px 0; }
    .cliente-row { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 10px; text-align: left; }
    #clientesLista { max-height: 500px; overflow-y: auto; text-align: left; }
    h1 { color: #84a59e; margin-bottom: 20px; }
    .loading { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ‘‘ UBIPET ADMIN</h1>
    
    <!-- Login -->
    <div id="loginAdmin">
      <input type="email" id="adminEmail" placeholder="samirignaciosb@gmail.com">
      <input type="password" id="adminPass" placeholder="Admin123">
      <button onclick="adminLogin()">ğŸ” ACCEDER ADMIN</button>
    </div>
    
    <!-- Dashboard -->
    <div id="adminDash" style="display:none;">
      <h2>ğŸ’° CLIENTES ACTIVOS ($15/placa)</h2>
      <div class="crear-form">
        <h3>â• NUEVO CLIENTE</h3>
        <input id="newEmail" placeholder="cliente@placa.cl">
        <input id="newPass" value="Ubipet123" style="width:200px;">
        <input id="newPhone" placeholder="+56912345678" style="width:200px;">
        <button id="btnCrearCliente" onclick="crearCliente()">ğŸš€ Crear + Notificar</button>
        <div id="statusMessage"></div>
      </div>
      <h3>ğŸ“Š MASCOTAS REGISTRADAS</h3>
      <div id="clientesLista">Cargando...</div>
      <button onclick="logoutAdmin()" style="background:#f44336;">ğŸšª Salir</button>
    </div>
  </div>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // SUPABASE CONFIG
    const SUPABASE_URL = 'https://exeeqykieytuvlzdbsnn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4ZWVxeWtpZXl0dXZsemRic25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDQ1MjMsImV4cCI6MjA4NzE4MDUyM30.874QQz_xUpJW7tT_iHWyiaeKELmK4reYYOzzlieMJq4';
    
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const SUPERUSER = { email: 'samirignaciosb@gmail.com', password: 'Admin123' };
    
    async function adminLogin() {
      const email = document.getElementById('adminEmail').value;
      const pass = document.getElementById('adminPass').value;
      
      if (email !== SUPERUSER.email || pass !== SUPERUSER.password) {
        alert('âŒ Solo: samirignaciosb@gmail.com / Admin123');
        return;
      }
      
      document.getElementById('loginAdmin').style.display = 'none';
      document.getElementById('adminDash').style.display = 'block';
      await cargarClientes();
      alert('âœ… Â¡ADMIN LIVE!');
    }
    
    function logoutAdmin() {
      document.getElementById('adminDash').style.display = 'none';
      document.getElementById('loginAdmin').style.display = 'block';
      document.getElementById('adminEmail').value = '';
      document.getElementById('adminPass').value = '';
    }
    
    async function crearCliente() {
      const email = document.getElementById('newEmail').value.trim();
      const pass = document.getElementById('newPass').value || 'Ubipet123';
      const telefono = document.getElementById('newPhone').value.trim();
      
      // Validaciones
      if (!email.includes('@')) {
        mostrarStatus('âŒ Email invÃ¡lido', 'error');
        return;
      }
      if (!telefono || !telefono.startsWith('569')) {
        mostrarStatus('âŒ TelÃ©fono invÃ¡lido (+569...)', 'error');
        return;
      }
      
      // Loading
      const btn = document.getElementById('btnCrearCliente');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'â³ Creando cliente...';
      btn.disabled = true;
      mostrarStatus('ğŸ”„ Creando usuario Supabase...', 'loading');
      
      try {
        // 1ï¸âƒ£ Crear usuario en Supabase AUTH
        const { data: authData, error: authError } = await supabase.auth.signUp({
          email,
          password: pass,
          options: {
            data: { telefono }
          }
        });
        
        if (authError) throw new Error(authError.message);
        
        // 2ï¸âƒ£ Crear perfil vacÃ­o
        const { error: profileError } = await supabase
          .from('perfiles')
          .insert({
            user_id: authData.user.id,
            nombre_mascota: 'Tu mascota ğŸ•',
            peso: '5kg',
            edad: '2 aÃ±os',
            raza: 'Mixta',
            nombre_dueno: 'DueÃ±o',
            telefono: telefono,
            email_dueno: email,
            esta_perdida: false,
            fotos: []
          });
        
        if (profileError) throw new Error(profileError.message);
        
        // 3ï¸âƒ£ Abrir Gmail TU (con copia)
        const gmailUrl = `mailto:samirignaciosb@gmail.com?subject=ğŸš€%20NUEVO%20CLIENTE%20Ubipet&body=NUEVO%20CLIENTE%20CREADO%0A%0AEmail:%20${email}%0APass:%20${pass}%0ATelÃ©fono:%20${telefono}%0A%0Aâœ…%20Listo%20para%20login%20UbiPet!%20ğŸ’°`;
        window.open(gmailUrl, '_blank');
        
        // 4ï¸âƒ£ WhatsApp TU (mensaje listo)
        const whatsappUrl = `https://wa.me/56979928352?text=ğŸ•%20*UBIPET%20NUEVO%20CLIENTE*%0A%0AğŸ“§%20${email}%0AğŸ”‘%20${pass}%0AğŸ“±%20${telefono}%0A%0Aâœ…%20Login%20listo%20en%20https://samirignaciosb-art.github.io/UbiPet/%0AğŸ’°%20Â¡Listo%20para%20cobrar%20$15!`;
        window.open(whatsappUrl, '_blank');
        
        // Ã‰XITO
        document.getElementById('newEmail').value = '';
        document.getElementById('newPhone').value = '';
        mostrarStatus(`âœ… CLIENTE CREADO! ${email} / ${pass}`, 'success');
        await cargarClientes();
        
        alert(`ğŸ‰ CLIENTE CREADO!\n\nğŸ“§ ${email}\nğŸ”‘ ${pass}\nğŸ“± ${telefono}\n\nâœ… Gmail + WhatsApp ABIERTOS\nğŸ’° Listo para placa $15`);
        
      } catch (error) {
        console.error('Error crear cliente:', error);
        mostrarStatus(`âŒ Error: ${error.message}`, 'error');
        alert(`âŒ Error: ${error.message}`);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
    
    function mostrarStatus(mensaje, tipo) {
      const status = document.getElementById('statusMessage');
      status.innerHTML = `<div class="${tipo}">${mensaje}</div>`;
      setTimeout(() => {
        status.innerHTML = '';
      }, 5000);
    }
    
    async function cargarClientes() {
      try {
        document.getElementById('clientesLista').innerHTML = 'ğŸ”„ Cargando...';
        
        const { data: clientes, error } = await supabase
          .from('perfiles')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        if (!clientes?.length) {
          document.getElementById('clientesLista').innerHTML = 'ğŸ• Sin clientes aÃºn';
          return;
        }
        
        document.getElementById('clientesLista').innerHTML = clientes.map(c => `
          <div class="cliente-row">
            <strong>ğŸ• ${c.nombre_mascota || 'Sin datos'}</strong><br>
            ğŸ‘¤ ${c.nombre_dueno || 'Sin dueÃ±o'} | ğŸ“§ ${c.email_dueno || 'Sin email'}<br>
            <span style="color:${c.esta_perdida ? '#f44336' : '#4CAF50'}; font-weight:bold;">
              ${c.esta_perdida ? 'ğŸš¨ PERDIDA' : 'ğŸŸ¢ ACTIVA'}
            </span><br>
            <small>ID: ${c.user_id?.slice(0,8)}... | ${new Date(c.created_at).toLocaleDateString('es-CL')}</small>
          </div>
        `).join('');
        
      } catch(error) {
        document.getElementById('clientesLista').innerHTML = `âŒ Error: ${error.message}`;
      }
    }
  </script>
</body>
</html>
