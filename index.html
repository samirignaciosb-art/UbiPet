<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ• Ubipet - Iniciar SesiÃ³n</title>
    <link rel="stylesheet" href="css/estilos.css?v=2">
</head>
<body>
    <div class="container">
        <h1>ğŸ” Ubipet</h1>
        <p style="color:#666; margin-bottom:20px;">Acceso para dueÃ±os de placas</p>
        
        <input type="email" id="emailInput" name="email" placeholder="tuemail@gmail.com">
        <input type="password" id="passwordInput" name="password" placeholder="123456">
        <button onclick="login()">ğŸš€ Iniciar SesiÃ³n</button>
        <p style="font-size:12px; color:#666;">Test: test@test.com / 123456</p>

        <div style="border-top: 2px solid #eee; padding-top: 25px; margin-top: 25px;">
            <button onclick="mostrarSolicitud()" class="whatsapp-btn">ğŸ‘‹ Nuevo? Activar cuenta</button>
        </div>
        <div style="margin: 20px 0; padding: 20px; background: #e8f5e8; border-radius: 10px;">
  <h3 style="color:#2e7d32;">ğŸ” Â¿Ya enviaste solicitud?</h3>
  <input id="checkEmail" placeholder="sa.sotob@duocuc.cl" style="width:70%;padding:12px;margin:10px;">
  <button onclick="checkEstadoSolicitud()" style="background:#4CAF50;color:white;padding:12px 24px;border:none;border-radius:8px;cursor:pointer;">ğŸ” VER ESTADO</button>
  <div id="estadoSolicitud" style="margin-top:15px;padding:10px;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://exeeqykieytuvlzdbsnn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4ZWVxeWtpZXl0dXZsemRic25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDQ1MjMsImV4cCI6MjA4NzE4MDUyM30.874QQz_xUpJW7tT_iHWyiaeKELmK4reYYOzzlieMJq4';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 1. CHECK ESTADO
async function checkEstadoSolicitud() {
  const email = document.getElementById('checkEmail').value.trim();
  if (!email.includes('@')) return alert('âŒ Email invÃ¡lido');
  
  try {
    const { data, error } = await sb.from('solicitudes_placas').select('aprobado').eq('email', email).single();
    const estado = document.getElementById('estadoSolicitud');
    
    if (error || !data) {
      estado.innerHTML = '<span style="color:orange;">â³ No encontramos tu solicitud</span>';
    } else if (!data.aprobado) {
      estado.innerHTML = '<span style="color:orange;">â³ Solicitud recibida - Esperando aprobaciÃ³n</span>';
    } else {
      estado.innerHTML = '<span style="color:green;font-size:18px;">âœ… Â¡APROBADO! <strong>CREA TU CUENTA</strong></span><br><br>';
      estado.innerHTML += '<button onclick="mostrarCrearCuenta()" style="background:#2196F3;color:white;padding:15px 30px;border:none;border-radius:10px;font-size:16px;cursor:pointer;">ğŸ” CREAR CUENTA UBIPET</button>';
    }
  } catch(error) {
    document.getElementById('estadoSolicitud').innerHTML = 'âŒ Error';
  }
}

// 2. CREAR CUENTA (PASO 4)
async function mostrarCrearCuenta() {
  const email = document.getElementById('emailInput').value.trim() || prompt('ğŸ“§ Tu email:');
  const password = prompt('ğŸ”‘ Crea contraseÃ±a:') || 'Ubipet123';
  
  if (!email || !password || password.length < 6) {
    return alert('âŒ Email + contraseÃ±a 6+ caracteres');
  }
  
  try {
    // 1ï¸âƒ£ CREAR CUENTA
    const { data: signUpData, error: signUpError } = await sb.auth.signUp({
      email: email.toLowerCase(),
      password,
      options: { data: { email, nombre: 'Cliente Ubipet' } }
    });
    
    if (signUpError) throw signUpError;
    
    // 2ï¸âƒ£ LOGIN AUTOMÃTICO INMEDIATO
    const { data: loginData, error: loginError } = await sb.auth.signInWithPassword({
      email: email.toLowerCase(),
      password
    });
    
    if (loginError?.message.includes('confirmed')) {
      alert('âœ… Â¡CUENTA CREADA! Revisa tu email.');
    } else if (loginData) {
      // âœ… LOGIN EXITOSO
      localStorage.setItem('user_token', loginData.session.access_token);
      localStorage.setItem('user_id', loginData.user.id);
      alert('âœ… Â¡CUENTA CREADA + LOGIN OK!');
      window.location.href = 'perfil.html';
    }
    
  } catch(error) {
    alert('âŒ ' + error.message);
  }
}

// 3. SOLICITUD NUEVA
window.mostrarSolicitud = async function() {
  const email = prompt('ğŸ“§ Tu email:');
  const nombre = prompt('ğŸ‘¤ Tu nombre:');
  const telefono = prompt('ğŸ“± Tu WhatsApp (+569...):');
  
  if (!email || !nombre || !telefono) {
    alert('âŒ Completa todos los campos');
    return;
  }
  
  try {
    await sb.from('solicitudes_placas').insert({
      email: email.toLowerCase(), nombre, telefono
    });
    
    const mensaje = `ğŸ• *NUEVA SOLICITUD UBIPET*\\nğŸ‘¤ ${nombre}\\nğŸ“§ ${email}\\nğŸ“± ${telefono}`;
    window.open(`https://wa.me/56979928352?text=${encodeURIComponent(mensaje)}`, '_blank');
    alert('âœ… Solicitud enviada! Te contactamos por WhatsApp.');
    
  } catch(error) {
    alert('âŒ Error: ' + error.message);
  }
}

// 4. LOGIN
window.login = async function() {
  const email = document.getElementById('emailInput').value.trim();
  const password = document.getElementById('passwordInput').value;
  
  if (!email || !password) {
    alert('âŒ Completa email y contraseÃ±a');
    return;
  }
  
  try {
    const { data, error } = await sb.auth.signInWithPassword({ 
      email: email.toLowerCase(), password 
    });
    
    if (error) throw error;
    
    localStorage.setItem('user_token', data.session.access_token);
    localStorage.setItem('user_id', data.user.id);
    alert('âœ… Â¡LOGIN OK! Redirigiendo...');
    window.location.href = 'perfil.html';
    
  } catch(error) {
    alert('âŒ ' + error.message);
  }
}

// Enter key
document.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') login();
});
</script>

</body>
</html>
