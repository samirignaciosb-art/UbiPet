<!DOCTYPE html>
<html>
<head>
    <title>UbiPet - Perfil</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>body{font-family:Arial;max-width:400px;margin:50px auto;padding:20px;}
    input,button{width:100%;padding:12px;margin:10px 0;font-size:16px;}
    #debug{color:#666;font-size:12px;}
    </style>
</head>
<body>
    <h2>üêï Perfil Mascota</h2>
    <div id="status">üîÑ Verificando...</div>
    <div id="form" style="display:none;">
        <input id="nombre" placeholder="Nombre *">
        <input id="raza" placeholder="Raza">
        <input id="edad" type="number" placeholder="Edad">
        <input id="peso" type="number" placeholder="Peso kg">
        <button onclick="guardar()">üíæ Guardar</button>
        <button onclick="salir()">üö™ Salir</button>
    </div>
    <div id="debug"></div>

    <script>
        const sb = supabase.createClient('https://exeeqykieytuvlzdbsnn.supabase.co', 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4ZWVxeWtpZXl0dXZsemRic25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDQ1MjMsImV4cCI6MjA4NzE4MDUyM30.874QQz_xUpJW7tT_iHWyiaeKELmK4reYYOzzlieMJq4');

        async function init() {
            document.getElementById('debug').innerHTML += '<br>1. Chequeando sesi√≥n...';
            const {data:{session}} = await sb.auth.getSession();
            if(!session){
                document.getElementById('status').innerHTML = '‚ùå Login requerido';
                setTimeout(()=>location.href='index.html',1500);
                return;
            }
            document.getElementById('debug').innerHTML += '<br>2. User OK: '+session.user.id.substring(0,8);
            
            // Cargar datos
            const {data, error} = await sb.from('perfiles').select('*').eq('user_id', session.user.id).single();
            document.getElementById('debug').innerHTML += '<br>3. Query OK, error: '+(error||'none');
            
            if(data){
                document.getElementById('nombre').value = data.nombre||'';
                document.getElementById('raza').value = data.raza||'';
                document.getElementById('edad').value = data.edad||'';
                document.getElementById('peso').value = data.peso||'';
            }
            
            document.getElementById('status').style.display='none';
            document.getElementById('form').style.display='block';
        }

        window.guardar = async function(){
            const {data:{session}} = await sb.auth.getSession();
            const perfil = {
                user_id: session.user.id,
                nombre: document.getElementById('nombre').value,
                raza: document.getElementById('raza').value,
                edad: parseInt(document.getElementById('edad').value)||null,
                peso: parseFloat(document.getElementById('peso').value)||null
            };
            const {error} = await sb.from('perfiles').upsert(perfil);
            alert(error ? '‚ùå '+error.message : '‚úÖ ¬°Guardado!');
        }

        window.salir = function(){
            sb.auth.signOut();
            location.href='index.html';
        }

        init();
    </script>
</body>
</html>
