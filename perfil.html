<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêï Ubipet - Perfil Mascota</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/estilos.css?v=2">
    
    <style>
        /* ESTILOS ESPEC√çFICOS perfil.html */
        #loading { 
            text-align: center; 
            padding: 40px; 
            font-size: 18px; 
            color: var(--pet-blue);
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 20px auto;
            max-width: 500px;
        }
    </style>
</head>

<body>
  <div class="container">
    <h1>üêï Ubipet - Perfil</h1>
    <p id="loading">üîê Verificando...</p>

    <div id="formPerfil" style="display:none;" class="form-grid">
      <!-- MASCOTA -->
      <div>
        <h3>üêæ Mascota</h3>
        <label>Nombre *</label>
        <input id="nombreMascota">
        <label>Raza</label>
        <input id="raza">
        <label>Edad (a√±os)</label>
        <input type="number" id="edad" min="0">
        <label>Peso (kg)</label>
        <input type="number" id="peso" step="0.1">
        <label>Vacunas al d√≠a</label>
        <input type="checkbox" id="vacunas">
        <label>Descripci√≥n</label>
        <textarea id="descripcion" rows="3"></textarea>
      </div>

      <!-- DUE√ëO -->
      <div>
        <h3>üë§ Due√±o</h3>
        <label>Nombre *</label>
        <input id="nombreDueno">
        <label>Email *</label>
        <input type="email" id="emailDueno">
        <label>Tel/WhatsApp *</label>
        <input type="tel" id="telefono">
        
        <button onclick="guardarPerfil()">üíæ GUARDAR PERFIL</button>
        <button onclick="cerrarSesion()" style="background:#666;">üö™ Salir</button>
      </div>
    </div>
  </div>

  <script>
    const sb = supabase.createClient('https://exeeqykieytuvlzdbsnn.supabase.co', 
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4ZWVxeWtpZXl0dXZsemRic25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDQ1MjMsImV4cCI6MjA4NzE4MDUyM30.874QQz_xUpJW7tT_iHWyiaeKELmK4reYYOzzlieMJq4');

    async function init() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        window.location.href = 'index.html';
        return;
      }
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('formPerfil').style.display = 'grid';
      
      try {
        const { data } = await sb.from('perfiles').select('*').eq('user_id', session.user.id).maybeSingle();
        if (data) {
          document.getElementById('nombreMascota').value = data.nombre || '';
          document.getElementById('raza').value = data.raza || '';
          document.getElementById('edad').value = data.edad || '';
          document.getElementById('peso').value = data.peso || '';
          document.getElementById('vacunas').checked = data.vacunas || false;
          document.getElementById('descripcion').value = data.descripcion || '';
          document.getElementById('nombreDueno').value = data.nombre_dueno || '';
          document.getElementById('emailDueno').value = data.email_dueno || '';
          document.getElementById('telefono').value = data.telefono || '';
        }
      } catch(e) {
        console.log('No hay perfil a√∫n');
      }
    }

    window.guardarPerfil = async function() {
      const { data: { session } } = await sb.auth.getSession();
      
      const perfilData = {
        user_id: session.user.id,  // ‚Üê CLAVE √öNICA
       nombre: document.getElementById('nombreMascota').value,
        raza: document.getElementById('raza').value,
        edad: parseInt(document.getElementById('edad').value) || null,
        peso: parseFloat(document.getElementById('peso').value) || null,
        vacunas: document.getElementById('vacunas').checked,
        descripcion: document.getElementById('descripcion').value,
        nombre_dueno: document.getElementById('nombreDueno').value,
        email_dueno: document.getElementById('emailDueno').value,
        telefono: document.getElementById('telefono').value
      };
      
      try {
        const { error } = await sb
          .from('perfiles')
          .upsert(perfilData, { 
            onConflict: 'user_id'
          });
        
        if (error) throw error;
        
        alert('‚úÖ ¬°PERFIL GUARDADO!');
        init(); // Recargar
      } catch(e) {
        alert('‚ùå ' + e.message);
      }
    };

    window.cerrarSesion = async function() {
      await sb.auth.signOut();
      window.location.href = 'index.html';
    };

    init();
  </script>
</body>
</html>
