<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ubipet - Perfil de Mascota</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial; max-width: 500px; margin: 20px auto; padding: 20px; background: #f5f5f5; }
    .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #4CAF50; margin-bottom: 30px; }
    h3 { color: #333; margin-top: 25px; border-bottom: 2px solid #4CAF50; padding-bottom: 5px; }
    input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    button { background: #4CAF50; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; }
    button:hover { background: #45a049; }
    .btn-secondary { background: #666; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .foto-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .toggle { width: 60px; height: 30px; background: #ddd; border-radius: 15px; position: relative; cursor: pointer; display: inline-block; }
    .toggle.active { background: #4CAF50; }
    .toggle-circle { width: 26px; height: 26px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; }
    .toggle.active .toggle-circle { transform: translateX(30px); }
    .qr-container { text-align: center; margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 15px; }
    .hidden { display: none; }
    #loading { text-align: center; color: #666; font-size: 18px; }
    #mensaje { padding: 15px; border-radius: 10px; margin-top: 20px; text-align: center; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ubipet ğŸ•</h1>
    <p id="loading">ğŸ” Verificando login...</p>
    <div id="mascotas-section" style="display:none; margin-bottom:20px;">
      <label>ğŸ• Mis Mascotas:</label>
      <select id="selectorMascotas" onchange="cambiarMascota()">
        <option value="">Selecciona una mascota...</option>
      </select>
      <button onclick="nuevaMascota()" class="btn-secondary">â• Nueva Mascota</button>
    </div>

    <div class="form-grid" id="formPerfil" style="display:none;">
      <!-- Columna Mascota -->
      <div>
        <h3>ğŸ¾ Datos de la Mascota</h3>
        <input type="text" id="nombreMascota" placeholder="Nombre *" required maxlength="50">
        <input type="number" id="peso" placeholder="Peso (kg)" step="0.1" min="0.1" max="100">
        <input type="number" id="edad" placeholder="Edad (aÃ±os)" min="0" max="30">
        <input type="text" id="raza" placeholder="Raza" maxlength="50">
        <input type="checkbox" id="vacunas"> Vacunas al dÃ­a
        <textarea id="descripcion" placeholder="Rasgos especiales, personalidad..." rows="3" maxlength="500"></textarea>
        
        <h3>ğŸ“¸ Fotos</h3>
        <input type="file" id="fotoInput" accept="image/*" onchange="previewFoto()">
        <img id="fotoPreview" style="max-width:150px; height:150px; object-fit:cover; border-radius:10px; display:none;">
        
        <h3>âš ï¸ Estado</h3>
        <label>Â¿EstÃ¡ perdida?</label>
        <div class="toggle" id="togglePerdida" onclick="togglePerdida()">
          <div class="toggle-circle"></div>
        </div>
        <input type="hidden" id="estaPerdida" value="false">
        <input type="hidden" id="perfilId">
      </div>

      <!-- Columna DueÃ±o -->
      <div>
        <h3>ğŸ‘¤ Datos del DueÃ±o</h3>
        <input type="text" id="nombreDueno" placeholder="Tu nombre completo *" required maxlength="100">
        <input type="email" id="emailDueno" placeholder="email@dominio.com" required>
        <input type="tel" id="telefono" placeholder="+56912345678" required pattern="\\+56[9][0-9]{8}">
        
        <button onclick="guardarPerfil()" id="btnGuardar">ğŸ’¾ Guardar Perfil</button>
        <button onclick="generarQR()" id="btnQR">ğŸ–¼ï¸ Generar QR (Placa)</button>
        
        <div style="margin-top:15px;">
          <button onclick="nuevaMascota()" class="btn-secondary">â• Nueva Mascota</button>
          <button onclick="cerrarSesion()" class="btn-secondary">ğŸšª Cerrar SesiÃ³n</button>
        </div>
      </div>
    </div>

    <!-- QR -->
    <div class="qr-container hidden" id="qrSection">
      <h3>ğŸ¯ QR para placa de RESCATE</h3>
      <img id="qrImg" style="width:250px; height:250px; border:3px solid #4CAF50; border-radius:15px;">
      <div id="urlPerfil" style="word-break: break-all; margin: 15px 0; padding:10px; background:#f0f0f0; border-radius:8px;"></div>
      <button onclick="copiarURL()">ğŸ“‹ Copiar URL</button>
      <button onclick="descargarQR()">â¬‡ï¸ Descargar PNG</button>
    </div>

    <div id="mensaje" style="display:none;"></div>
  </div>

  <script>
    const supabaseUrl = 'https://exeeqykieytuvlzdbsnn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4ZWVxeWtpZXl0dXZsemRic25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA1MzA1NDcsImV4cCI6MjA0NjEwNjU0N30.ZY3d8g1mJ4p9zLh0oQ4p2q0lF3p8a9b0c1d2e3f4g5h6i7j8k9l0m1n2o3p4q5'; 
    const sb = supabase.createClient(supabaseUrl, supabaseKey);
    
    let currentUserId = null;
    let currentPerfilId = null;

    // ğŸ” VERIFICACIÃ“N SUPABASE REAL (NO localStorage)
    async function verificarLogin() {
      try {
        const { data: { session }, error } = await sb.auth.getSession();
        if (!session || error) {
          localStorage.clear();
          window.location.href = 'index.html';
          return false;
        }
        currentUserId = session.user.id;
        document.getElementById('loading').textContent = 'âœ… Cargando perfil...';
        await cargarPerfiles();
        return true;
      } catch(e) {
        mostrarMensaje('Error de conexiÃ³n', 'error');
        setTimeout(() => window.location.href = 'index.html', 2000);
        return false;
      }
    }

    async function cargarPerfiles() {
      const { data, error } = await sb
        .from('perfiles')
        .select('id, nombre, esta_perdida')
        .eq('user_id', currentUserId);
      
      if (error) {
        mostrarMensaje('Error cargando perfiles', 'error');
        return;
      }
      
      const select = document.getElementById('selectorMascotas');
      data.forEach(perfil => {
        const option = document.createElement('option');
        option.value = perfil.id;
        option.textContent = perfil.nombre || 'Mascota sin nombre';
        select.appendChild(option);
      });
      
      document.getElementById('mascotas-section').style.display = 'block';
      if (data.length > 0) cambiarMascota();
      else document.getElementById('formPerfil').style.display = 'grid';
    }

    window.cambiarMascota = async function() {
      const perfilId = document.getElementById('selectorMascotas').value;
      if (!perfilId) return;
      
      currentPerfilId = perfilId;
      document.getElementById('perfilId').value = perfilId;
      
      const { data, error } = await sb
        .from('perfiles')
        .select('*')
        .eq('id', perfilId)
        .single();
        
      if (data) {
        document.getElementById('nombreMascota').value = data.nombre || '';
        document.getElementById('peso').value = data.peso || '';
        document.getElementById('edad').value = data.edad || '';
        document.getElementById('raza').value = data.raza || '';
        document.getElementById('vacunas').checked = data.vacunas || false;
        document.getElementById('descripcion').value = data.descripcion || '';
        document.getElementById('estaPerdida').value = data.esta_perdida || 'false';
        actualizarToggle();
      }
      
      document.getElementById('formPerfil').style.display = 'grid';
    }

    window.guardarPerfil = async function() {
      if (!currentUserId) return;
      
      const perfil = {
        user_id: currentUserId,
        nombre: document.getElementById('nombreMascota').value,
        peso: parseFloat(document.getElementById('peso').value) || null,
        edad: parseInt(document.getElementById('edad').value) || null,
        raza: document.getElementById('raza').value,
        vacunas: document.getElementById('vacunas').checked,
        descripcion: document.getElementById('descripcion').value,
        esta_perdida: document.getElementById('estaPerdida').value === 'true',
        ...(currentPerfilId && { id: currentPerfilId })
      };
      
      const { error } = await sb.from('perfiles').upsert(perfil);
      if (error) mostrarMensaje('Error guardando: ' + error.message, 'error');
      else {
        mostrarMensaje('âœ… Perfil guardado!', 'success');
        await cargarPerfiles();
      }
    }

    window.nuevaMascota = async function() {
      document.querySelectorAll('input, textarea').forEach(el => el.value = '');
      document.getElementById('vacunas').checked = false;
      document.getElementById('estaPerdida').value = 'false';
      document.getElementById('perfilId').value = '';
      document.getElementById('formPerfil').style.display = 'grid';
      document.getElementById('selectorMascotas').value = '';
    }

    window.togglePerdida = function() {
      const toggle = document.getElementById('togglePerdida');
      const estado = document.getElementById('estaPerdida');
      const nuevoEstado = estado.value === 'true' ? 'false' : 'true';
      estado.value = nuevoEstado;
      toggle.classList.toggle('active');
    }

    function actualizarToggle() {
      const toggle = document.getElementById('togglePerdida');
      if (document.getElementById('estaPerdida').value === 'true') {
        toggle.classList.add('active');
      } else {
        toggle.classList.remove('active');
      }
    }

    window.generarQR = function() {
      if (!currentPerfilId) {
        mostrarMensaje('Guarda primero el perfil', 'error');
        return;
      }
      document.getElementById('qrSection').classList.remove('hidden');
      document.getElementById('urlPerfil').textContent = `https://samirignaciosb-art.github.io/UbiPet/perfil-publico.html?id=${currentPerfilId}`;
      // QR simulado (GitHub Pages no permite QR real)
      document.getElementById('qrImg').src = 'https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=' + encodeURIComponent(`https://samirignaciosb-art.github.io/UbiPet/perfil-publico.html?id=${currentPerfilId}`);
    }

    window.copiarURL = function() {
      navigator.clipboard.writeText(document.getElementById('urlPerfil').textContent);
      mostrarMensaje('âœ… URL copiada!', 'success');
    }

    window.descargarQR = function() {
      const link = document.createElement('a');
      link.href = document.getElementById('qrImg').src;
      link.download = 'ubipet-qr.png';
      link.click();
    }

    function mostrarMensaje(texto, tipo) {
      const msg = document.getElementById('mensaje');
      msg.textContent = texto;
      msg.className = tipo;
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 3000);
    }

    window.cerrarSesion = function() {
      sb.auth.signOut();
      localStorage.clear();
      window.location.href = 'index.html';
    }

    // ğŸš€ INICIO AUTOMÃTICO
    verificarLogin();
  </script>
</body>
</html>
