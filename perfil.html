<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ubipet - Perfil de Mascota</title>
  <link rel="stylesheet" href="css/estilos.css">
</head>
<body>
  <div class="container">
    <h1>Ubipet üêï</h1>
    <p id="loading">üîê Verificando login...</p>

    <!-- SELECTOR MASCOTAS -->
    <div id="mascotas-section" style="display:none; margin-bottom:20px;">
      <label>üêï Mis Mascotas:</label>
      <select id="selectorMascotas" onchange="cambiarMascota()">
        <option value="">Selecciona una mascota...</option>
      </select>
    </div>

    <!-- FORMULARIO ORIGINAL -->
    <div class="form-grid" id="formPerfil" style="display:none;">
      <!-- Columna Mascota -->
      <div>
        <h3>üêæ Datos Mascota</h3>
        <label>Nombre *</label>
        <input type="text" id="nombreMascota" placeholder="Nombre" required maxlength="50">
        <label>Raza</label>
        <input type="text" id="raza" placeholder="Raza" maxlength="50">
        <label>Edad</label>
        <input type="number" id="edad" placeholder="Edad" min="0" max="30">
        <label>Peso (kg)</label>
        <input type="number" id="peso" placeholder="Peso" step="0.1" min="0.1">
      </div>

      <!-- Columna Due√±o -->
      <div>
        <h3>üë§ Datos Due√±o</h3>
        <label>Nombre *</label>
        <input type="text" id="nombreDueno" placeholder="Tu nombre">
        <label>Tel√©fono/WhatsApp *</label>
        <input type="tel" id="telefono" placeholder="+56912345678">
        
        <button onclick="guardarPerfil()" style="margin-top:20px;">üíæ Guardar</button>
        <button onclick="cerrarSesion()">üö™ Salir</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = 'https://exeeqykieytuvlzdbsnn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4ZWVxeWtpZXl0dXZsemRic25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDQ1MjMsImV4cCI6MjA4NzE4MDUyM30.874QQz_xUpJW7tT_iHWyiaeKELmK4reYYOzzlieMJq4';
    const sb = supabase.createClient(supabaseUrl, supabaseKey);

    async function verificarLogin() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        window.location.href = 'index.html';
        return false;
      }
      return session.user.id;
    }

    window.cargarPerfiles = async function() {
      const userId = await verificarLogin();
      if (!userId) return;
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('mascotas-section').style.display = 'block';
      
      const { data } = await sb.from('perfiles').select('id, nombre').eq('user_id', userId);
      const select = document.getElementById('selectorMascotas');
      
      data?.forEach(perfil => {
        const option = document.createElement('option');
        option.value = perfil.id;
        option.textContent = perfil.nombre || 'Sin nombre';
        select.appendChild(option);
      });
    }

    window.cambiarMascota = async function() {
      const userId = await verificarLogin();
      const perfilId = document.getElementById('selectorMascotas').value;
      
      if (!perfilId) {
        document.getElementById('formPerfil').style.display = 'grid';
        return;
      }
      
      const { data } = await sb.from('perfiles').select('*').eq('id', perfilId).single();
      if (data) {
        document.getElementById('nombreMascota').value = data.nombre || '';
        document.getElementById('raza').value = data.raza || '';
        document.getElementById('edad').value = data.edad || '';
        document.getElementById('peso').value = data.peso || '';
        document.getElementById('nombreDueno').value = data.nombre_dueno || '';
        document.getElementById('telefono').value = data.telefono || '';
      }
      
      document.getElementById('formPerfil').style.display = 'grid';
    }

    window.guardarPerfil = async function() {
      const userId = await verificarLogin();
      const perfil = {
        user_id: userId,
        nombre: document.getElementById('nombreMascota').value,
        raza: document.getElementById('raza').value,
        edad: parseInt(document.getElementById('edad').value) || null,
        peso: parseFloat(document.getElementById('peso').value) || null,
        nombre_dueno: document.getElementById('nombreDueno').value,
        telefono: document.getElementById('telefono').value
      };
      
      const { error } = await sb.from('perfiles').upsert(perfil);
      alert(error ? '‚ùå ' + error.message : '‚úÖ ¬°Guardado!');
      
      if (!error) window.cargarPerfiles();
    }

    window.cerrarSesion = async function() {
      await sb.auth.signOut();
      window.location.href = 'index.html';
    }

    // INICIO
    window.cargarPerfiles();
  </script>
</body>
</html>
